// ==UserScript==
// @name        chatemotes-userscript
// @version     0.0.0
// @license     MIT
// @homepage    https://atestacraft.github.io/chatemotes-userscript/
// @match       *://7tv.app/*
// @match       *://betterttv.com/*
// @match       *://www.frankerfacez.com/*
// @grant       GM_getValue
// @grant       GM_addStyle
// @updateURL   https://atestacraft.github.io/chatemotes-userscript/chatemotes-userscript.meta.js
// @downloadURL https://atestacraft.github.io/chatemotes-userscript/chatemotes-userscript.user.js
// ==/UserScript==

var oe=Object.defineProperty,se=(m,h,b)=>h in m?oe(m,h,{enumerable:!0,configurable:!0,writable:!0,value:b}):m[h]=b,a=(m,h,b)=>(se(m,typeof h!="symbol"?h+"":h,b),b);(function(){"use strict";function m(o,t,e=document.body){const n=new MutationObserver(i=>{for(const s of i){const r=s.target.querySelector(o);r&&t(r)}});return n.observe(e,{attributes:!0,childList:!0,subtree:!0}),n}function h(o,t,...e){const n=document.createElement(o);return Array.isArray(t)?n.append(...t):(Object.assign(n,t),Object.assign(n.style,t?.style),n.append(...e)),n}async function b(){return new Promise(o=>{document.readyState=="loading"?document.addEventListener("DOMContentLoaded",()=>o(),{once:!0}):o()})}const $=["GET","POST","PUT","PATCH","DELETE"];class U{constructor(t,e){a(this,"get"),a(this,"post"),a(this,"put"),a(this,"patch"),a(this,"delete"),this.baseURL=t,this.baseInit=e;for(const n of $)this[n.toLowerCase()]=(i,s)=>this.request(i,{...s,method:n})}async request(t,e){var n;const i=new URL(t,this.baseURL),s=G((n=this.baseInit)==null?void 0:n.headers,e.headers);return await M(i,{...this.baseInit,...e,headers:s})}}async function M(...o){const t=await fetch(...o),e=await t.json();if(t.ok)return e;throw new R({response:t,data:e})}class R extends Error{constructor({response:t,data:e}){super(t.statusText),a(this,"response"),a(this,"data"),this.name="FetcherError",this.response=t,this.data=e}}function G(...o){const t={};for(const e of o){const n=new Headers(e);for(const[i,s]of n.entries())s==null?delete t[i]:t[i]=s}return new Headers(t)}const x="https://vchcode-emotes.satont.dev/api/",_=new U(x,{headers:{"Content-Type":"application/json",Authorization:GM_getValue("API_TOKEN")}});async function H(){return await _.get("emotes")}async function p(o,t){return await _.put("emote",{body:JSON.stringify({name:o,url:t})})}async function y(o){return await _.delete(`emote/${o}`)}async function F(o=1e3){return new Promise(t=>setTimeout(t,o))}class A{constructor(t){a(this,"emotesName"),this.emotes=t,this.emotesName=t.map(e=>e.name),this.render()}static init(t){return new A(t)}async render(){m(".emote-card-list",async t=>{if(t.matches(".seven-tv"))return;t.classList.add("seven-tv"),await F();const e=document.querySelectorAll("[emote-id] > .emote-card");for(const n of e){const i=n.querySelector(".title-banner").textContent;this.emotesName.includes(i)&&(n.style.filter="drop-shadow(rgb(23, 227, 53) 0.03em 0.03em 0.075em) drop-shadow(black 1px 1px 1px)")}}),m(".actions-wrapper",t=>{t.matches(".seven-tv")||(t.classList.add("seven-tv"),this.renderAddButton(t))})}renderAddButton(t){E.init(t,this.emotes)}}class E{constructor(t,e){a(this,"isAdded"),a(this,"emoteName"),a(this,"button"),this.target=t,this.emotes=e,this.emoteName=document.querySelector(".emote-name").textContent;const n=this.emotes.find(i=>i.name===this.emoteName);this.isAdded=Boolean(n),this.render()}static init(t,e){return new E(t,e)}toggleButton(){this.isAdded=!this.isAdded,this.button.querySelector("span").textContent=`[ChatEmotes] ${this.isAdded?"Delete":"Add"}`}render(){this.button=this.target.querySelectorAll(".action-group")[1].cloneNode(!0),this.button.querySelector(".action-icon").remove(),this.button.querySelector("span").textContent="[ChatEmotes] Add",this.button.addEventListener("click",async()=>{try{this.isAdded?await y(this.emoteName):await p(this.emoteName,location.href),this.toggleButton()}catch(t){console.error(t)}}),this.target.appendChild(this.button)}}class N{constructor(t){a(this,"addToChannelSelector","#root > div > div.chakra-container > div > div > div:nth-child(1) > div:nth-child(5) > div > button"),a(this,"emotesPreviewXPath","/html/body/div[1]/div/div[2]/div/div/div[1]/div[2]"),this.emotes=t,this.render()}static init(t){return new N(t)}async render(){m(this.addToChannelSelector,t=>{this.renderAddButton(t)})}renderAddButton(t){t.matches(".bttv-button")||(t.classList.add("bttv-button"),S.init(t,this.emotes))}}class S{constructor(t,e){a(this,"isAdded"),a(this,"button"),a(this,"emoteName"),this.target=t,this.emotes=e;const n=document.querySelectorAll(".chakra-heading")[2];this.emoteName=n.textContent;const i=this.emotes.find(s=>s.name===this.emoteName);this.isAdded=Boolean(i),this.render()}static init(t,e){return new S(t,e)}toggleButton(){this.isAdded=!this.isAdded,Object.assign(this.button,this.getButtonAttributes())}getButtonAttributes(){return{textContent:`[ChatEmotes] ${this.isAdded?"Delete":"Add"}`,className:`${this.target.className} bttv-${this.isAdded?"del":"add"}-button`}}render(){this.button=h("button",{...this.getButtonAttributes(),type:"button",onclick:async()=>{try{this.button.setAttribute("disabled","true"),this.isAdded?await y(this.emoteName):await p(this.emoteName,location.href),this.toggleButton()}catch(t){console.error(t)}finally{this.button.removeAttribute("disabled")}}}),this.target.after(this.button)}}function V(o,t){var e=J(o),n=e.tag,i=e.id,s=e.className,r=t?document.createElementNS(t,n):document.createElement(n);return i&&(r.id=i),s&&(t?r.setAttribute("class",s):r.className=s),r}function J(o){for(var t=o.split(/([.#])/),e="",n="",i=1;i<t.length;i+=2)switch(t[i]){case".":e+=" "+t[i+1];break;case"#":n=t[i+1]}return{className:e.trim(),tag:t[0]||"div",id:n}}function K(o,t,e){var n=t.__redom_lifecycle;if(T(n)){t.__redom_lifecycle={};return}var i=e;for(t.__redom_mounted&&v(t,"onunmount");i;){var s=i.__redom_lifecycle||{};for(var r in n)s[r]&&(s[r]-=n[r]);T(s)&&(i.__redom_lifecycle=null),i=i.parentNode}}function T(o){if(o==null)return!0;for(var t in o)if(o[t])return!1;return!0}var X=["onmount","onremount","onunmount"],Q=typeof window<"u"&&"ShadowRoot"in window;function W(o,t,e,n){var i=f(o),s=f(t);t===s&&s.__redom_view&&(t=s.__redom_view),t!==s&&(s.__redom_view=t);var r=s.__redom_mounted,c=s.parentNode;if(r&&c!==i&&K(t,s,c),e!=null)if(n){var d=f(e);d.__redom_mounted&&v(d,"onunmount"),i.replaceChild(s,d)}else i.insertBefore(s,f(e));else i.appendChild(s);return Y(t,s,i,c),t}function v(o,t){t==="onmount"||t==="onremount"?o.__redom_mounted=!0:t==="onunmount"&&(o.__redom_mounted=!1);var e=o.__redom_lifecycle;if(e){var n=o.__redom_view,i=0;n&&n[t]&&n[t]();for(var s in e)s&&i++;if(i)for(var r=o.firstChild;r;){var c=r.nextSibling;v(r,t),r=c}}}function Y(o,t,e,n){for(var i=t.__redom_lifecycle||(t.__redom_lifecycle={}),s=e===n,r=!1,c=0,d=X;c<d.length;c+=1){var w=d[c];s||o!==t&&w in o&&(i[w]=(i[w]||0)+1),i[w]&&(r=!0)}if(!r){t.__redom_lifecycle={};return}var u=e,C=!1;for((s||u&&u.__redom_mounted)&&(v(t,s?"onremount":"onmount"),C=!0);u;){var B=u.parentNode,I=u.__redom_lifecycle||(u.__redom_lifecycle={});for(var q in i)I[q]=(I[q]||0)+i[q];if(C)break;(u.nodeType===Node.DOCUMENT_NODE||Q&&u instanceof ShadowRoot||B&&B.__redom_mounted)&&(v(u,s?"onremount":"onmount"),C=!0),u=B}}function Z(o,t,e){var n=f(o);if(typeof t=="object")for(var i in t)P(n,i,t[i]);else P(n,t,e)}function P(o,t,e){o.style[t]=e??""}var L="http://www.w3.org/1999/xlink";function D(o,t,e,n){var i=f(o),s=typeof t=="object";if(s)for(var r in t)D(i,r,t[r],n);else{var c=i instanceof SVGElement,d=typeof e=="function";if(t==="style"&&typeof e=="object")Z(i,e);else if(c&&d)i[t]=e;else if(t==="dataset")O(i,e);else if(!c&&(t in i||d)&&t!=="list")i[t]=e;else{if(c&&t==="xlink"){j(i,e);return}n&&t==="class"&&(e=i.className+" "+e),e==null?i.removeAttribute(t):i.setAttribute(t,e)}}}function j(o,t,e){if(typeof t=="object")for(var n in t)j(o,n,t[n]);else e!=null?o.setAttributeNS(L,t,e):o.removeAttributeNS(L,t,e)}function O(o,t,e){if(typeof t=="object")for(var n in t)O(o,n,t[n]);else e!=null?o.dataset[t]=e:delete o.dataset[t]}function tt(o){return document.createTextNode(o??"")}function z(o,t,e){for(var n=0,i=t;n<i.length;n+=1){var s=i[n];if(!(s!==0&&!s)){var r=typeof s;r==="function"?s(o):r==="string"||r==="number"?o.appendChild(tt(s)):et(f(s))?W(o,s):s.length?z(o,s,e):r==="object"&&D(o,s,null,e)}}}function f(o){return o.nodeType&&o||!o.el&&o||f(o.el)}function et(o){return o&&o.nodeType}function g(o){for(var t=[],e=arguments.length-1;e-- >0;)t[e]=arguments[e+1];var n,i=typeof o;if(i==="string")n=V(o);else if(i==="function"){var s=o;n=new(Function.prototype.bind.apply(s,[null].concat(t)))}else throw new Error("At least one argument required");return z(f(n),t,!0),n}var l=g;g.extend=function(){for(var o=[],t=arguments.length;t--;)o[t]=arguments[t];return g.bind.apply(g,[this].concat(o))};class k{constructor(t){a(this,"emote"),a(this,"emoteNames"),a(this,"isAdded",!1),a(this,"pathnames",["submissions","emoticons","channel","emoticon"]),a(this,"addEmoteButton"),a(this,"delEmoteButton"),a(this,"emoticonThead"),a(this,"emoticonTbodyLight"),a(this,"emoticonTbodyDark"),a(this,"emoticonPreview"),this.emotes=t,this.emoteNames=this.emotes.map(e=>e.name),this.render()}static init(t){return new k(t)}render(){const t=location.pathname.split("/").filter(Boolean),e=this.pathnames.find(n=>t.includes(n));if(e)switch(e){case"submissions":case"emoticons":case"channel":this.renderPanel();break;case"emoticon":this.parseEmoteInfo(),this.renderEmoteButtons(),this.renderEmotePreview()}}toggleAdded(){this.isAdded=!this.isAdded}toggleEmoticonUI(){this.toggleAdded(),this.toggleButtons(),this.renderEmotePreview()}toggleButtons(){this.addEmoteButton.style.display=this.isAdded?"none":"initial",this.delEmoteButton.style.display=this.isAdded?"initial":"none"}renderEmoteButtons(){var t;this.addEmoteButton=l("a",{textContent:"[ChatEmotes] Add",className:"btn btn-large btn-success ffz-button",href:"#",onclick:n=>{n.preventDefault(),p(this.emote.name,this.emote.url).then(()=>this.toggleEmoticonUI()).catch(console.error)}}),this.delEmoteButton=l("a",{textContent:"[ChatEmotes] Delete",className:"btn btn-large btn-danger ffz-button",href:"#",onclick:n=>{n.preventDefault(),y(this.emote.name).then(()=>this.toggleEmoticonUI()).catch(console.error)}});const e=(t=document.querySelector(".btn-success"))!=null?t:document.querySelector(".btn-danger");e&&(this.toggleButtons(),e.after(this.addEmoteButton,this.delEmoteButton))}renderEmotePreview(){const t=document.querySelector(".emoticon-grid");if(!t)return;if(!this.isAdded){if(!this.emoticonPreview)return;Object.values(this.emoticonPreview).forEach(n=>n.remove());return}this.emoticonThead=t.querySelector("thead > tr"),this.emoticonTbodyLight=t.querySelector("tbody > .light"),this.emoticonTbodyDark=t.querySelector("tbody > .dark");const e=l("td",l("img",{className:"emoticon hover-pixelated",src:`${x}emote/${this.emote.name}`}));this.emoticonPreview={th:l("th","ChatEmotes"),dark:e,light:e.cloneNode(!0)},this.emoticonThead.prepend(this.emoticonPreview.th),this.emoticonTbodyDark.prepend(this.emoticonPreview.dark),this.emoticonTbodyLight.prepend(this.emoticonPreview.light)}parseEmoteInfo(){const t=document.querySelector("#emoticon").textContent.split(" ")[0];this.emotes.find(e=>e.name===t)&&this.toggleAdded(),this.emote={name:t,url:location.href}}renderPanel(){const t=document.querySelectorAll("td > input");for(const i of t){const s=i.getAttribute("data-name");this.emoteNames.includes(s)&&i.parentElement.classList.add("ffz-added")}const e=document.querySelector(".sidebar-offcanvas"),n=l("div",{className:"panel panel-default"},l("div",{textContent:"ChatEmotes",className:"panel-heading"}),l("div",{className:"list-group"},l("a",{textContent:"Add Selected",className:"list-group-item",href:"#",onclick:async i=>{i.preventDefault();const s=document.querySelectorAll(".selectable.active > td > input");for(const r of s)try{const c=r.getAttribute("data-name"),d=`https://cdn.frankerfacez.com/emoticon/${r.getAttribute("data-id")}/2`;await p(c,d),r.parentElement.classList.add("ffz-added")}catch(c){console.error(c)}finally{r.click()}}}),l("a",{textContent:"Delete Selected",className:"list-group-item",href:"#",onclick:async i=>{i.preventDefault();const s=document.querySelectorAll(".selectable.active > td > input");for(const r of s)try{const c=r.getAttribute("data-name");await y(c),r.parentElement.classList.remove("ffz-added")}catch(c){console.error(c)}finally{r.click()}}})));e?.appendChild(n)}}const nt="";async function ot(){const o=await H();switch(location.hostname){case"7tv.app":A.init(o);break;case"betterttv.com":N.init(o);break;case"www.frankerfacez.com":k.init(o);break}}b().then(()=>ot()),GM_addStyle(".ffz-button{margin-left:1rem}.selectable>td.ffz-added{background-color:#0ce3ac}.bttv-add-button{color:#a8dcfa!important}.bttv-add-button:hover{background:rgba(168,220,250,.12)!important}.bttv-del-button{color:#feb2b2!important}.bttv-del-button:hover{background:rgba(254,178,178,.12)!important}")})();
