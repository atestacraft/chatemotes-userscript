// ==UserScript==
// @name        chatemotes-userscript
// @version     0.0.0
// @license     MIT
// @homepage    https://atestacraft.github.io/chatemotes-userscript/
// @match       *://7tv.app/*
// @match       *://betterttv.com/*
// @match       *://www.frankerfacez.com/*
// @grant       GM_getValue
// @grant       GM_addStyle
// @updateURL   https://atestacraft.github.io/chatemotes-userscript/chatemotes-userscript.meta.js
// @downloadURL https://atestacraft.github.io/chatemotes-userscript/chatemotes-userscript.user.js
// ==/UserScript==

var ee=Object.defineProperty,te=(f,m,v)=>m in f?ee(f,m,{enumerable:!0,configurable:!0,writable:!0,value:v}):f[m]=v,a=(f,m,v)=>(te(f,typeof m!="symbol"?m+"":m,v),v);(function(){"use strict";function f(o,t,e=document.body){const i=new MutationObserver(n=>{for(const r of n){const s=r.target.querySelector(o);s&&t(s)}});return i.observe(e,{attributes:!0,childList:!0,subtree:!0}),i}function m(o,t,...e){const i=document.createElement(o);return Array.isArray(t)?i.append(...t):(Object.assign(i,t),Object.assign(i.style,t?.style),i.append(...e)),i}async function v(){return new Promise(o=>{document.readyState=="loading"?document.addEventListener("DOMContentLoaded",()=>o(),{once:!0}):o()})}const z=["GET","POST","PUT","PATCH","DELETE"];class I{constructor(t,e){a(this,"get"),a(this,"post"),a(this,"put"),a(this,"patch"),a(this,"delete"),this.baseURL=t,this.baseInit=e;for(const i of z)this[i.toLowerCase()]=(n,r)=>this.request(n,{...r,method:i})}async request(t,e){var i;const n=new URL(t,this.baseURL),r=M((i=this.baseInit)==null?void 0:i.headers,e.headers);return await U(n,{...this.baseInit,...e,headers:r})}}async function U(...o){const t=await fetch(...o),e=await t.json();if(t.ok)return e;throw new $({response:t,data:e})}class $ extends Error{constructor({response:t,data:e}){super(t.statusText),a(this,"response"),a(this,"data"),this.name="FetcherError",this.response=t,this.data=e}}function M(...o){const t={};for(const e of o){const i=new Headers(e);for(const[n,r]of i.entries())r==null?delete t[n]:t[n]=r}return new Headers(t)}const C="https://vchcode-emotes.satont.dev/api/",g=new I(C,{headers:{"Content-Type":"application/json",Authorization:GM_getValue("API_TOKEN")}});async function R(){return await g.get("emotes")}async function _(o,t){return await g.put("emote",{body:JSON.stringify({name:o,url:t})})}async function w(o){return await g.delete(`emote/${o}`)}class A{constructor(t){a(this,"addToChannelSelector","#root > div > div.chakra-container > div > div > div:nth-child(1) > div:nth-child(5) > div > button"),a(this,"emotesPreviewXPath","/html/body/div[1]/div/div[2]/div/div/div[1]/div[2]"),this.emotes=t,this.render()}static init(t){return new A(t)}async render(){f(this.addToChannelSelector,t=>{this.renderAddButton(t)})}renderAddButton(t){t.matches(".bttv-button")||(t.classList.add("bttv-button"),E.init(t,this.emotes))}}class E{constructor(t,e){a(this,"isAdded"),a(this,"button"),a(this,"emoteName"),this.target=t,this.emotes=e;const i=document.querySelectorAll(".chakra-heading")[2];this.emoteName=i.textContent;const n=this.emotes.find(r=>r.name===this.emoteName);this.isAdded=Boolean(n),this.render()}static init(t,e){return new E(t,e)}toggleButton(){this.isAdded=!this.isAdded,Object.assign(this.button,this.getButtonAttributes())}getButtonAttributes(){return{textContent:`[ChatEmotes] ${this.isAdded?"Delete":"Add"}`,className:`${this.target.className} bttv-${this.isAdded?"del":"add"}-button`}}render(){this.button=m("button",{...this.getButtonAttributes(),type:"button",onclick:async()=>{try{this.button.setAttribute("disabled",!0),this.isAdded?await w(this.emoteName):await _(this.emoteName,location.href),this.toggleButton()}catch(t){console.error(t)}finally{this.button.removeAttribute("disabled")}}}),this.target.after(this.button)}}function G(o,t){var e=H(o),i=e.tag,n=e.id,r=e.className,s=t?document.createElementNS(t,i):document.createElement(i);return n&&(s.id=n),r&&(t?s.setAttribute("class",r):s.className=r),s}function H(o){for(var t=o.split(/([.#])/),e="",i="",n=1;n<t.length;n+=2)switch(t[n]){case".":e+=" "+t[n+1];break;case"#":i=t[n+1]}return{className:e.trim(),tag:t[0]||"div",id:i}}function F(o,t,e){var i=t.__redom_lifecycle;if(T(i)){t.__redom_lifecycle={};return}var n=e;for(t.__redom_mounted&&b(t,"onunmount");n;){var r=n.__redom_lifecycle||{};for(var s in i)r[s]&&(r[s]-=i[s]);T(r)&&(n.__redom_lifecycle=null),n=n.parentNode}}function T(o){if(o==null)return!0;for(var t in o)if(o[t])return!1;return!0}var V=["onmount","onremount","onunmount"],J=typeof window<"u"&&"ShadowRoot"in window;function K(o,t,e,i){var n=h(o),r=h(t);t===r&&r.__redom_view&&(t=r.__redom_view),t!==r&&(r.__redom_view=t);var s=r.__redom_mounted,c=r.parentNode;if(s&&c!==n&&F(t,r,c),e!=null)if(i){var d=h(e);d.__redom_mounted&&b(d,"onunmount"),n.replaceChild(r,d)}else n.insertBefore(r,h(e));else n.appendChild(r);return X(t,r,n,c),t}function b(o,t){t==="onmount"||t==="onremount"?o.__redom_mounted=!0:t==="onunmount"&&(o.__redom_mounted=!1);var e=o.__redom_lifecycle;if(e){var i=o.__redom_view,n=0;i&&i[t]&&i[t]();for(var r in e)r&&n++;if(n)for(var s=o.firstChild;s;){var c=s.nextSibling;b(s,t),s=c}}}function X(o,t,e,i){for(var n=t.__redom_lifecycle||(t.__redom_lifecycle={}),r=e===i,s=!1,c=0,d=V;c<d.length;c+=1){var y=d[c];r||o!==t&&y in o&&(n[y]=(n[y]||0)+1),n[y]&&(s=!0)}if(!s){t.__redom_lifecycle={};return}var u=e,k=!1;for((r||u&&u.__redom_mounted)&&(b(t,r?"onremount":"onmount"),k=!0);u;){var S=u.parentNode,j=u.__redom_lifecycle||(u.__redom_lifecycle={});for(var B in n)j[B]=(j[B]||0)+n[B];if(k)break;(u.nodeType===Node.DOCUMENT_NODE||J&&u instanceof ShadowRoot||S&&S.__redom_mounted)&&(b(u,r?"onremount":"onmount"),k=!0),u=S}}function Q(o,t,e){var i=h(o);if(typeof t=="object")for(var n in t)P(i,n,t[n]);else P(i,t,e)}function P(o,t,e){o.style[t]=e??""}var q="http://www.w3.org/1999/xlink";function x(o,t,e,i){var n=h(o),r=typeof t=="object";if(r)for(var s in t)x(n,s,t[s],i);else{var c=n instanceof SVGElement,d=typeof e=="function";if(t==="style"&&typeof e=="object")Q(n,e);else if(c&&d)n[t]=e;else if(t==="dataset")D(n,e);else if(!c&&(t in n||d)&&t!=="list")n[t]=e;else{if(c&&t==="xlink"){L(n,e);return}i&&t==="class"&&(e=n.className+" "+e),e==null?n.removeAttribute(t):n.setAttribute(t,e)}}}function L(o,t,e){if(typeof t=="object")for(var i in t)L(o,i,t[i]);else e!=null?o.setAttributeNS(q,t,e):o.removeAttributeNS(q,t,e)}function D(o,t,e){if(typeof t=="object")for(var i in t)D(o,i,t[i]);else e!=null?o.dataset[t]=e:delete o.dataset[t]}function W(o){return document.createTextNode(o??"")}function O(o,t,e){for(var i=0,n=t;i<n.length;i+=1){var r=n[i];if(!(r!==0&&!r)){var s=typeof r;s==="function"?r(o):s==="string"||s==="number"?o.appendChild(W(r)):Y(h(r))?K(o,r):r.length?O(o,r,e):s==="object"&&x(o,r,null,e)}}}function h(o){return o.nodeType&&o||!o.el&&o||h(o.el)}function Y(o){return o&&o.nodeType}function p(o){for(var t=[],e=arguments.length-1;e-- >0;)t[e]=arguments[e+1];var i,n=typeof o;if(n==="string")i=G(o);else if(n==="function"){var r=o;i=new(Function.prototype.bind.apply(r,[null].concat(t)))}else throw new Error("At least one argument required");return O(h(i),t,!0),i}var l=p;p.extend=function(){for(var o=[],t=arguments.length;t--;)o[t]=arguments[t];return p.bind.apply(p,[this].concat(o))};class N{constructor(t){a(this,"emote"),a(this,"emoteNames"),a(this,"isAdded",!1),a(this,"pathnames",["submissions","emoticons","channel","emoticon"]),a(this,"addEmoteButton"),a(this,"delEmoteButton"),a(this,"emoticonThead"),a(this,"emoticonTbodyLight"),a(this,"emoticonTbodyDark"),a(this,"emoticonPreview"),this.emotes=t,this.emoteNames=this.emotes.map(e=>e.name),this.render()}static init(t){return new N(t)}render(){const t=location.pathname.split("/").filter(Boolean),e=this.pathnames.find(i=>t.includes(i));if(e)switch(e){case"submissions":case"emoticons":case"channel":this.renderPanel();break;case"emoticon":this.parseEmoteInfo(),this.renderEmoteButtons(),this.renderEmotePreview()}}toggleAdded(){this.isAdded=!this.isAdded}toggleEmoticonUI(){this.toggleAdded(),this.toggleButtons(),this.renderEmotePreview()}toggleButtons(){this.addEmoteButton.style.display=this.isAdded?"none":"initial",this.delEmoteButton.style.display=this.isAdded?"initial":"none"}renderEmoteButtons(){var t;this.addEmoteButton=l("a",{textContent:"[ChatEmotes] Add",className:"btn btn-large btn-success ffz-button",href:"#",onclick:i=>{i.preventDefault(),_(this.emote.name,this.emote.url).then(()=>this.toggleEmoticonUI()).catch(console.error)}}),this.delEmoteButton=l("a",{textContent:"[ChatEmotes] Delete",className:"btn btn-large btn-danger ffz-button",href:"#",onclick:i=>{i.preventDefault(),w(this.emote.name).then(()=>this.toggleEmoticonUI()).catch(console.error)}});const e=(t=document.querySelector(".btn-success"))!=null?t:document.querySelector(".btn-danger");e&&(this.toggleButtons(),e.after(this.addEmoteButton,this.delEmoteButton))}renderEmotePreview(){const t=document.querySelector(".emoticon-grid");if(!t)return;if(!this.isAdded){if(!this.emoticonPreview)return;Object.values(this.emoticonPreview).forEach(i=>i.remove());return}this.emoticonThead=t.querySelector("thead > tr"),this.emoticonTbodyLight=t.querySelector("tbody > .light"),this.emoticonTbodyDark=t.querySelector("tbody > .dark");const e=l("td",l("img",{className:"emoticon hover-pixelated",src:`${C}emote/${this.emote.name}`}));this.emoticonPreview={th:l("th","ChatEmotes"),dark:e,light:e.cloneNode(!0)},this.emoticonThead.prepend(this.emoticonPreview.th),this.emoticonTbodyDark.prepend(this.emoticonPreview.dark),this.emoticonTbodyLight.prepend(this.emoticonPreview.light)}parseEmoteInfo(){const t=document.querySelector("#emoticon").textContent.split(" ")[0];this.emotes.find(e=>e.name===t)&&this.toggleAdded(),this.emote={name:t,url:location.href}}renderPanel(){const t=document.querySelectorAll("td > input");for(const n of t){const r=n.getAttribute("data-name");this.emoteNames.includes(r)&&n.parentElement.classList.add("ffz-added")}const e=document.querySelector(".sidebar-offcanvas"),i=l("div",{className:"panel panel-default"},l("div",{textContent:"ChatEmotes",className:"panel-heading"}),l("div",{className:"list-group"},l("a",{textContent:"Add Selected",className:"list-group-item",href:"#",onclick:async n=>{n.preventDefault();const r=document.querySelectorAll(".selectable.active > td > input");for(const s of r)try{const c=s.getAttribute("data-name"),d=`https://cdn.frankerfacez.com/emoticon/${s.getAttribute("data-id")}/2`;await _(c,d),s.parentElement.classList.add("ffz-added")}catch(c){console.error(c)}finally{s.click()}}}),l("a",{textContent:"Delete Selected",className:"list-group-item",href:"#",onclick:async n=>{n.preventDefault();const r=document.querySelectorAll(".selectable.active > td > input");for(const s of r)try{const c=s.getAttribute("data-name");await w(c),s.parentElement.classList.remove("ffz-added")}catch(c){console.error(c)}finally{s.click()}}})));e?.appendChild(i)}}const tt="";async function Z(){const o=await R();switch(location.hostname){case"7tv.app":console.log("7tv provider loaded");break;case"betterttv.com":A.init(o);break;case"www.frankerfacez.com":N.init(o);break}}v().then(()=>Z()),GM_addStyle(".ffz-button{margin-left:1rem}.selectable>td.ffz-added{background-color:#0ce3ac}.bttv-add-button{color:#a8dcfa!important}.bttv-add-button:hover{background:rgba(168,220,250,.12)!important}.bttv-del-button{color:#feb2b2!important}.bttv-del-button:hover{background:rgba(254,178,178,.12)!important}")})();
